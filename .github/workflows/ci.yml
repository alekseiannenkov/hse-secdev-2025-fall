name: CI

on:
  push:
    branches: [ main, p07-container-hardening ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff black isort pytest

      - name: Lint (ruff)
        run: ruff check .

      - name: Format check (black)
        run: black --check .

      - name: Imports check (isort)
        run: isort --check-only .

      - name: Tests
        run: pytest -q

  hadolint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          wget -O /tmp/hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x /tmp/hadolint

      - name: Run hadolint on Dockerfile
        run: /tmp/hadolint -c hadolint.yml Dockerfile

  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker (already available on ubuntu-latest)
        run: docker version

      - name: Build Docker image
        run: docker build -t hse-wishlist:ci .

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@v0.33.1
        with:
          image-ref: hse-wishlist:ci
          format: 'table'
          exit-code: '0'       # чтобы CI не падал из-за найденных HIGH/CRITICAL
          ignore-unfixed: true
          severity: CRITICAL,HIGH
