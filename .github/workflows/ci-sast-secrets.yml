name: P10 – SAST & Secrets

on:
  push:
    paths:
      - "**/*.py"
      - "security/**"
      - "EVIDENCE/P10/**"
      - ".github/workflows/ci-sast-secrets.yml"
  workflow_dispatch:

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  security-sast-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence directory
        run: |
          mkdir -p EVIDENCE/P10

      # --- SAST: Semgrep ---
      - name: Run Semgrep (SAST)
        run: |
          docker run --rm -v "$PWD:/src" returntocorp/semgrep:latest \
            semgrep ci \
              --config p/ci \
              --config /src/security/semgrep/rules.yml \
              --sarif --output /src/EVIDENCE/P10/semgrep.sarif \
              --metrics=off || true

      # --- Secrets: Gitleaks ---
      - name: Run Gitleaks (secrets scanning)
        run: |
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest \
            detect \
              --no-banner \
              --config=/repo/security/.gitleaks.toml \
              --source=/repo \
              --report-format=json \
              --report-path=/repo/EVIDENCE/P10/gitleaks.json || true

      # --- SAST summary (простая сводка) ---
      - name: Generate SAST summary
        run: |
          TOTAL=$(jq '.runs[0].results | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)

          echo "## SAST Summary" > EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "- Total findings (all severities): ${TOTAL}" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "Подробности см. в EVIDENCE/P10/semgrep.sarif." >> EVIDENCE/P10/sast_summary.md

      # --- Upload artifacts (для ★★ по C1–C3) ---
      - name: Upload Semgrep SARIF
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: EVIDENCE/P10/semgrep.sarif

      - name: Upload Gitleaks report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: EVIDENCE/P10/gitleaks.json

      - name: Upload SAST summary
        uses: actions/upload-artifact@v4
        with:
          name: sast-summary
          path: EVIDENCE/P10/sast_summary.md
